<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Test - Mock Data</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        #test-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            padding: 1rem;
            border-radius: 8px;
            z-index: 1000;
            max-width: 300px;
        }
        #test-controls h3 {
            margin-top: 0;
            color: var(--accent);
        }
        #error-log {
            background: var(--bg-tertiary);
            border: 1px solid var(--error);
            padding: 0.5rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.7rem;
            color: var(--error);
        }
        .test-pass { color: var(--success); }
        .test-fail { color: var(--error); }
    </style>
</head>
<body>
    <div id="test-controls">
        <h3>Test Dashboard</h3>
        <div id="test-status">
            <div>Elements: <span id="elements-status">Checking...</span></div>
            <div>Data Load: <span id="data-status">Checking...</span></div>
            <div>Components: <span id="components-status">Checking...</span></div>
        </div>
        <div id="error-log"></div>
    </div>

    <div id="app">
        <header>
            <h1>MNIST Exploration Dashboard (TEST MODE)</h1>
            <div id="stats"></div>
        </header>

        <main>
            <div id="left-panel">
                <section id="treemap-section">
                    <div class="section-header">
                        <h2>Model Overview</h2>
                        <div id="treemap-breadcrumb"></div>
                    </div>
                    <div id="treemap"></div>
                </section>

                <section id="model-stats-section">
                    <h2>Top Models</h2>
                    <div id="model-stats"></div>
                </section>

                <section id="correlation-section">
                    <h2>Digit Correlation</h2>
                    <div id="correlation"></div>
                </section>
            </div>

            <div id="center-panel">
                <section id="image-grid-section">
                    <div class="section-header">
                        <h2>Images</h2>
                        <div id="filters">
                            <span id="active-filter" style="font-size: 0.8rem; color: var(--accent);"></span>
                            <select id="digit-filter">
                                <option value="all">All Digits</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                            </select>
                            <select id="sort-by">
                                <option value="difficulty-asc">Hardest First</option>
                                <option value="difficulty-desc">Easiest First</option>
                                <option value="digit">By Digit</option>
                                <option value="id">By Index</option>
                            </select>
                            <input type="range" id="difficulty-range" min="0" max="100" value="0">
                            <span id="difficulty-label">Min difficulty: 0%</span>
                            <button id="clear-filters" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer;">Clear</button>
                        </div>
                    </div>
                    <div id="image-grid"></div>
                </section>
            </div>

            <div id="right-panel">
                <section id="training-curves-section">
                    <div class="section-header">
                        <h2>Training Curves</h2>
                        <select id="model-selector" style="font-size: 0.8rem; padding: 0.25rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px;">
                            <option value="">Select model...</option>
                        </select>
                    </div>
                    <div id="training-curves"></div>
                </section>

                <section id="details-section">
                    <h2>Details</h2>
                    <div id="details">
                        <p class="placeholder">Click an image to see details</p>
                    </div>
                </section>

                <section id="checkpoint-section">
                    <div class="section-header">
                        <h2>Checkpoint Explorer</h2>
                        <input type="range" id="checkpoint-slider" min="0" max="0" value="0" style="width: 100%;" disabled>
                    </div>
                    <div id="checkpoint-info" style="font-size: 0.8rem; color: var(--text-secondary);">
                        Select a model to explore checkpoints
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="tooltip" class="hidden"></div>

    <script type="module">
        import { createForceGraph } from './js/forceGraph.js';
        import { createCorrelationMatrix } from './js/correlation.js';
        import { createImageGrid } from './js/imageGrid.js';
        import { createDetailsPanel } from './js/details.js';
        import { createTrainingCurves } from './js/trainingCurves.js';

        // Error logging
        const errorLog = document.getElementById('error-log');
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const msg = args.join(' ');
            errorLog.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${msg}</div>`;
            errorLog.scrollTop = errorLog.scrollHeight;
            originalConsoleError.apply(console, args);
        };

        window.addEventListener('error', (e) => {
            errorLog.innerHTML += `<div>${e.message} at ${e.filename}:${e.lineno}</div>`;
            errorLog.scrollTop = errorLog.scrollHeight;
        });

        // Test required elements
        const requiredElements = [
            'stats', 'treemap', 'model-stats', 'correlation', 'image-grid',
            'details', 'training-curves', 'digit-filter', 'sort-by',
            'difficulty-range', 'checkpoint-slider'
        ];

        const elementsStatus = document.getElementById('elements-status');
        const missingElements = requiredElements.filter(id => !document.getElementById(id));

        if (missingElements.length === 0) {
            elementsStatus.innerHTML = '<span class="test-pass">✓ All present</span>';
        } else {
            elementsStatus.innerHTML = `<span class="test-fail">✗ Missing: ${missingElements.join(', ')}</span>`;
        }

        // Generate mock data
        function generateMockData() {
            const NUM_MODELS = 10;
            const NUM_IMAGES = 100;

            // Mock base64 image (1x1 pixel)
            const mockImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';

            const images = [];
            for (let i = 0; i < NUM_IMAGES; i++) {
                const digit = i % 10;
                images.push({
                    id: i,
                    digit: digit,
                    difficulty: Math.random(),
                    correct_by: Array.from({length: Math.floor(Math.random() * NUM_MODELS)},
                                          () => Math.floor(Math.random() * NUM_MODELS)),
                    image: mockImage
                });
            }

            const models = [];
            for (let i = 0; i < NUM_MODELS; i++) {
                const checkpoints = [];
                for (let epoch = 10; epoch <= 50; epoch += 10) {
                    const sample_correct = Array(NUM_IMAGES).fill(false).map(() => Math.random() > 0.5);
                    checkpoints.push({
                        epoch: epoch,
                        train_acc: 0.9 + Math.random() * 0.1,
                        eval_acc: 0.3 + Math.random() * 0.3,
                        digit_accs: Object.fromEntries(
                            Array.from({length: 10}, (_, d) => [d, Math.random()])
                        ),
                        sample_correct: sample_correct,
                        loss: 0.5 / epoch
                    });
                }

                models.push({
                    id: i,
                    training_indices: Array.from({length: 20},
                                                () => Math.floor(Math.random() * NUM_IMAGES)),
                    test_accuracy: 0.3 + Math.random() * 0.3,
                    checkpoints: checkpoints
                });
            }

            const digit_correlation = Array(10).fill(0).map(() =>
                Array(10).fill(0).map(() => Math.random() * 2 - 1)
            );

            return {
                config: {
                    num_models: NUM_MODELS,
                    samples_per_digit: 2,
                    target_train_acc: 0.99,
                    seed: 42,
                    checkpoint_freq: 10
                },
                models: models,
                images: images,
                digit_correlation: digit_correlation,
                model_correlation: []
            };
        }

        // Global state
        const state = {
            data: null,
            selectedImage: null,
            highlightedImages: new Set(),
            filters: {
                digit: 'all',
                sort: 'difficulty-asc',
                minDifficulty: 0
            }
        };

        // Event bus
        const events = {
            listeners: {},
            on(event, callback) {
                if (!this.listeners[event]) this.listeners[event] = [];
                this.listeners[event].push(callback);
            },
            emit(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(cb => cb(data));
                }
            }
        };

        // Tooltip
        const tooltip = {
            el: document.getElementById('tooltip'),
            show(html, x, y) {
                this.el.innerHTML = html;
                this.el.classList.remove('hidden');
                const rect = this.el.getBoundingClientRect();
                const vw = window.innerWidth;
                const vh = window.innerHeight;
                let left = x + 10;
                let top = y + 10;
                if (left + rect.width > vw) left = x - rect.width - 10;
                if (top + rect.height > vh) top = y - rect.height - 10;
                this.el.style.left = left + 'px';
                this.el.style.top = top + 'px';
            },
            hide() {
                this.el.classList.add('hidden');
            }
        };

        // Initialize
        async function init() {
            const dataStatus = document.getElementById('data-status');
            const componentsStatus = document.getElementById('components-status');

            try {
                // Load mock data
                state.data = generateMockData();
                dataStatus.innerHTML = '<span class="test-pass">✓ Mock data loaded</span>';

                // Update stats
                document.getElementById('stats').textContent =
                    `${state.data.config.num_models} models | ${state.data.images.length} images | ${state.data.config.samples_per_digit} samples/digit`;

                // Initialize components
                createForceGraph('#treemap', state, events, tooltip);
                createCorrelationMatrix('#correlation', state, events, tooltip);
                createImageGrid('#image-grid', state, events, tooltip);
                createDetailsPanel('#details', state, events);
                createTrainingCurves('#training-curves', state, events);

                componentsStatus.innerHTML = '<span class="test-pass">✓ All initialized</span>';

                // Setup filters
                const digitFilter = document.getElementById('digit-filter');
                const sortBy = document.getElementById('sort-by');
                const difficultyRange = document.getElementById('difficulty-range');
                const difficultyLabel = document.getElementById('difficulty-label');
                const clearBtn = document.getElementById('clear-filters');

                digitFilter.addEventListener('change', (e) => {
                    state.filters.digit = e.target.value;
                    events.emit('filter-change', state.filters);
                });

                sortBy.addEventListener('change', (e) => {
                    state.filters.sort = e.target.value;
                    events.emit('filter-change', state.filters);
                });

                difficultyRange.addEventListener('input', (e) => {
                    state.filters.minDifficulty = parseInt(e.target.value) / 100;
                    difficultyLabel.textContent = `Min difficulty: ${e.target.value}%`;
                    events.emit('filter-change', state.filters);
                });

                clearBtn.addEventListener('click', () => {
                    state.filters.modelId = undefined;
                    state.filters.digit = 'all';
                    state.filters.minDifficulty = 0;
                    digitFilter.value = 'all';
                    difficultyRange.value = 0;
                    difficultyLabel.textContent = 'Min difficulty: 0%';
                    events.emit('filter-change', state.filters);
                    events.emit('highlight-images', []);
                });

            } catch (error) {
                console.error('Error initializing:', error);
                dataStatus.innerHTML = `<span class="test-fail">✗ ${error.message}</span>`;
                componentsStatus.innerHTML = '<span class="test-fail">✗ Failed</span>';
            }
        }

        init();
    </script>
</body>
</html>
